---
keyword: [金丝雀, 网关, 灰度发布]
---

# 金丝雀发布

金丝雀发布，即灰度发布，是服务治理领域中最重要的策略之一。在微服务应用新版本发布上线时，可以先通过金丝雀发布进行小规模流量验证，待验证通过后再进行全量升级。云原生网关可以为接入网关的微服务应用提供金丝雀发布的能力。

已在**云原生网关** \> **服务管理**模块中导入目标服务。具体操作，请参见[添加服务](/cn.zh-CN/云原生网关/服务管理/添加服务.md)。

**说明：** 目前，云原生网关金丝雀发布能力只支持ACK容器服务。

云原生网关金丝雀发布的过程如下：

![云原生网关金丝雀发布](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1374576261/p296450.png)

1.  **初始状态**：假设您有1个后端服务Demo-Service需要通过云原生网关接入，在ACK集群中已部署与Demo-Service相关的K8s Service和Deployment资源，您需要为Demo-Service服务Deployment中的Pod模板添加一个标签表示稳定版本，例如：`version: v1`。

    **说明：** 标签支持自定义，推荐使用version。对应的标签值也支持自定义，推荐使用vx（x表示版本号）。

2.  **创建路由规则**：通过云原生网关控制台的**路由配置**模块将服务Demo-Service接入网关。例如配置请求路径为/demo的流量转发到后端服务Demo-Service。具体操作，请参见[新建路由规则](/cn.zh-CN/云原生网关/路由配置管理/新建路由规则.md)。
3.  **创建金丝雀策略**：此时服务Demo-Service有新版本要发布上线，在部署灰度版本的Deployment之前，首先需要为服务Demo-Service配置金丝雀策略，配置用于区分服务版本的标签为version，配置服务的稳定版本为v1，配置即将部署的灰度版本为v2。
4.  **部署灰度版本**：在ACK集群中为Demo-Service新建一个Deployment表示灰度版本，您需要在Deployment中的Pod模板添加一个标签来表示灰度版本，标签的值取决于金丝雀策略中灰度版本的标签值，例如：`version: v2`。

    **说明：** 您需要在容器管理控制台上为Deployment中的Pod设置标签并部署应用。

5.  **当前流量比例**：新部署的灰度版本不会影响线上已有的流量，请求路径为/demo的流量仍然全部转发到服务Demo-Serive的稳定版本v1。
6.  **调整流量比例**：为灰度版本进行小规模的流量验证，您可以配置稳定版本与灰度版本的流量比例，请求路径为/demo的流量将按照您设置的流量比例进行转发。
7.  **完成金丝雀发布**：当灰度版本的功能验证通过后，如果您需要灰度版本全量升级，可以通过金丝雀发布的初始化功能将灰度版本v2类型升级为稳定版本，并设置下一次金丝雀发布所用的版本和类型。您可以采用以下任一方式来设置下一次金丝雀发布所用的版本和类型：
    -   如果您想通过两个标签值轮转的方式来进行每一次的发布，那么只需将稳定版本v1类型更改为灰度版本。
    -   如果您想通过不同的标签值来进行每一次的发布，那么需要更改稳定版本v1的值（例如更改为v3），同时更新类型为灰度版本。

        **说明：** 选择该方式初始化，需在容器管理控制台上为Deployment中的Pod添加相应版本的标签并部署应用。


如果您的服务之前已经在云原生网关中配置过路由规则，或者该服务之前已经进行过金丝雀发布，那么您只需确保当前服务的Deployment中有稳定版本的标签，就可以直接配置金丝雀策略。

## 创建金丝雀策略

1.  登录[MSE网关管理控制台](https://mse.console.aliyun.com/#/microgw)。

2.  在左侧导航栏选择**云原生网关** \> **网关列表**。

3.  在顶部菜单栏选择地域。

4.  在**网关列表**页面，单击目标网关名称或**操作**列下的**管理**。

5.  在**网关详情**页面左侧导航栏单击**服务管理**。

6.  在**服务管理**页面单击目标服务操作列下方的**策略配置**。

7.  在**策略配置**区域单击**金丝雀**页签，然后在右侧单击**立即创建**。

8.  在**创建金丝雀**面板中配置金丝雀发布规则，然后单击**确定**。

    ![创建金丝雀](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/2374576261/p296442.png)

    参数说明如下：

    |参数|描述|
    |--|--|
    |**区分服务版本的标签**|请从后端服务所在Pod的标签中选择，标签支持自定义，推荐使用version。|
    |**服务版本**|云原生网关金丝雀发布要求必须配置两个不同类型的版本。    -   **标签值**：指所选标签对应的值，推荐使用为vx（x表示版本号）。
    -   **类型**：包括稳定版本和灰度版本，且两个服务版本类型不能相同。 |

    **说明：** 第一次创建金丝雀发布规则时，100%的流量将转发到服务的稳定版本v1，0%的流量将转发到服务的灰度版本v2。


## 分配流量比例

金丝雀发布规则设置完成后，为稳定版本v1和灰度版本v2分配流量比例。

1.  登录[MSE网关管理控制台](https://mse.console.aliyun.com/#/microgw)。

2.  在左侧导航栏选择**云原生网关** \> **网关列表**。

3.  在顶部菜单栏选择地域。

4.  在**网关列表**页面，单击目标网关名称或**操作**列下的**管理**。

5.  在**网关详情**页面左侧导航栏单击**服务管理**。

6.  在**服务管理**页面单击目标服务操作列下方的**策略配置**。

7.  在**策略配置**区域单击**金丝雀**页签，然后单击右侧的**流量分配**。

8.  在不同标签版本的**流量比例**列配置流量百分比，然后单击**保存**。

    ![流量分配](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/2374576261/p296414.png)

    **说明：** 配置比例总和必须满足100%。


## 初始化金丝雀发布

当您对灰度版本进行小流量验证通过后，需要将灰度版本全量升级为稳定版本。通过初始化即可重新编辑金丝雀策略，您可以选择将当前的灰度版本修改为稳定版本，然后修改原有稳定版本的标签值，并且类型变更为灰度版本，为下一次的金丝雀发布做准备。

1.  登录[MSE网关管理控制台](https://mse.console.aliyun.com/#/microgw)。

2.  在左侧导航栏选择**云原生网关** \> **网关列表**。

3.  在顶部菜单栏选择地域。

4.  在**网关列表**页面，单击目标网关名称或**操作**列下的**管理**。

5.  在**网关详情**页面左侧导航栏单击**服务管理**。

6.  在**服务管理**页面单击目标服务操作列下方的**策略配置**。

7.  在**策略配置**区域单击**金丝雀**页签，然后单击右侧的**金丝雀**。

8.  在**编辑金丝雀**面板中初始化金丝雀发布，然后单击**确定**。

    ![初始化金丝雀](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/2374576261/p296422.png)

    您可以采用以下任一方式来设置下一次金丝雀发布所用的版本和类型：

    -   如果您想通过两个标签值轮转的方式来进行每一次的发布，那么只需将稳定版本v1类型更改为灰度版本。
    -   如果您想通过不同的标签值来进行每一次的发布，那么需要更改稳定版本v1的值（例如更改为v3），同时更新类型为灰度版本。

        **说明：** 选择该方式初始化，需在容器管理控制台上为Deployment中的Pod添加相应版本的标签并部署应用。


## 相关操作

若您无需使用云原生网关的金丝雀发布能力，在**策略配置**区域的**金丝雀**页签右侧单击**删除**，在弹出的对话框中单击**确认**即可。

