---
keyword: [微服务, 服务治理, 金丝雀发布]
---

# 金丝雀发布

部署在阿里云容器服务ACK集群、ASK集群、自建并注册ACK集群中的Spring Cloud或Dubbo微服务应用，为了确保其升级的安全性，可以使用金丝雀发布（即灰度发布）进行小规模验证，验证通过后再全量升级。

已在ACK集群中安装MSE治理中心组件，并为ACK授予MSE治理中心的访问权限。具体操作，请参见[容器服务Kubernetes版中的应用接入MSE微服务治理]()。

金丝雀发布的过程如下：

![金丝雀发布流程](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9462216061/p184580.png)

1.  **初始状态**：比如有2个服务Order-Service和Pay-Service，Order-Service作为Consumer服务会去调用Pay-Service提供的服务。在您没有接入MSE治理中心之前，Order-Service和Pay-Service都对应一个Deployment应用，并且没有设置任何标签。
2.  **部署灰度版本**：为Pay-Service部署灰度版本，此时Pay-Service新建一个Deployment应用表示灰度版本，并设置标签。具体操作，请参见[在ACK中为应用接入MSE微服务治理并设置标签](https://help.aliyun.com/document_detail/170454.html#title-oe1-vwq-g3h)。

    **说明：** 默认情况下，MSE治理中心会让100%的流量转发至没有打标签的Deployment应用。

3.  **设置流量规则**：为Pay-Service设置流量规则：HTTP HEADER中env=test。此时满足该规则的流量会转发至灰度Deployment应用，其他流量转发至正常Deployment应用。
4.  **调整流量比例**：为灰度版本调整流量比例，让更多的流量转发至灰度Deployment应用。

    **说明：** 满足流量规则的流量还是会转发至灰度Deployment应用，不满足流量规则的流量有20%的概率转发至灰度Deployment应用。

5.  **完成灰度发布**：灰度验证完毕，此时100%的流量转发至灰度Deployment应用。

    **说明：** 建议您删除正常的Deployment应用或者将正常的Deployment应用副本数改为0。


## 使用限制

金丝雀发布功能只适合在两个标签的场景下使用，若有多个标签的场景，请使用标签路由。具体操作，请参见[配置标签路由]()。

## 操作步骤

本文主要介绍的事配置流量规则的步骤，其他步骤请根据实际业务需求完成。

1.  登录[MSE治理中心控制台](https://mse.console.aliyun.com/?spm=a2c4g.11186623.2.13.f90a6a60WiEx0N#/msc/home)。

2.  在左侧导航栏选择**微服务治理中心** \> **应用列表**。

3.  选择具体应用，单击**操作**列的**金丝雀**。

    或者单击具体应用名称，在**应用详情**页面选择**服务治理**区域，单击**金丝雀**页签。

4.  单击**应用实例**右侧的**编辑**按钮，在**修改金丝雀路由**面板中的**流量规则**区域配置流量规则相关参数，然后单击**确定**。

    ![金丝雀发布springcloud](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7003775061/p183915.png)

    流量规则配置相关参数说明如下。

    |参数|描述|
    |--|--|
    |**框架类型**|根据实际应用自动生成相应的框架类型。|
    |**Path**|选择服务路径，也可单击右侧的**切换为自定义输入**手动输入路径。|
    |**条件模式**|包含**同时满足下列条件**或**满足下列任一条件**，根据实际需求选择。|
    |**条件列表**|设置条件参数，当有多个条件规则时，可通过单击**添加新的规则条件**添加。

可以分别设置Cookie、Header、Parameter和Body Content四种类型的参数。例如：

    -   Cookie：`hello = "world" 或 "world2"`
    -   Parameter：`name=newversion` |
    |**是否链路传递**|如果需要使用全链路流控，请打开**是否链路传递**开关。如需使用，请参见[配置标签路由]()。|

    路由规则设置完成后，访问的请求带上规则里的参数，这时流量会去访问灰度Deployment应用。

5.  在**应用实例**区域中的**流量比例**列配置流量百分比，然后单击**确定**。

    **说明：** 流量规则验证成功后，再调大灰度版本流量比例，建议逐渐调大灰度版本的流量比例。

    ![流量比例](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3719675061/p183874.png)


## 执行结果

**金丝雀验证成功** ：单击**发布完成**按钮，灰度版本的流量比例会被调整为100%，配置的流量规则会被清除。此时所有的流量都会被转发到灰度Deployment应用，然后可以删除老版本的应用。

**说明：** 发布完成后，该标签对应的灰度版本成为新的基线版本，之后若要再进行金丝雀发布，可以为新的Deployment设置新的标签，新的标签会成为灰度版本。

**金丝雀验证失败**：单击**回滚**按钮，灰度版本的流量比例会被调整为0%，配置的流量规则会被清除。此时所有的流量都会被转发到正常Deployment应用，然后可以删除灰度版本的应用。

