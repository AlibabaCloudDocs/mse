# 根据后端RT自动调整流量的负载均衡策略

微服务网关提供后端RT自动调整流量的负载均衡策略，可以极大程度减少由后端应用实例的处理能力差异带来的业务损失。

已经部署微服务（[微服务应用Demo](https://aliware-images.oss-cn-hangzhou.aliyuncs.com/csb/sc-microservice-example.zip)）到阿里云，请参见[部署应用到阿里云](https://help.aliyun.com/document_detail/160719.html?spm=a2c4g.11186623.6.555.1270759dXyrsFb)。

挂载在微服务网关的后端应用实例，其处理能力往往存在差异。当实例间的处理能力差异较大时，可能会造成业务处理延迟，带来业务损失，而后端RT自动流量调整的负载均衡策略可以极大程度减少由后端应用实例的处理能力差异带来的业务损失。

## 操作步骤

1.  登录[微服务网关控制台](https://microgw.console.aliyun.com)。

2.  在左侧导航栏选择**网关管理**。

3.  在**网关管理**页面顶部菜单栏选择地域，然后单击网关名称。

4.  在**网关详情**页面左侧导航栏单击**API管理**。

5.  在**API管理**页面单击API名称。

6.  在**API详情**页面的**策略**区域添加策略，然后单击**保存**。

    添加策略包含创建策略和选择已有策略两种方式。

    -   创建策略
        1.  在**API管理**页面**请求处理**区域单击**创建策略**。
        2.  在**创建策略**页面设置**策略名称**、**策略类型**和**策略配置**，然后单击**确认**。

            ![创建策略](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8849993951/p128067.png)

            创建策略参数说明：

            |参数|描述|
            |--|--|
            |**策略名称**|自定义设置策略名称。|
            |**策略别名**|自定义设置易于辨识策略的别名信息。|
            |**策略类型**|选择**负载均衡-RIBBON**。|
            |**启用状态**|策略开关，默认开启。|
            |**策略配置**|            -   NIWSServerListClassName：负载均衡算法，本场景必须设置为com.netflix.loadbalancer.WeightedResponseTimeRule，即根据后端RT自动调整后端服务接收的请求流量的算法。
            -   listOfServers：服务器列表。
                -   从注册中心添加服务场景：服务器列表会根据注册中心注册的服务自动生成，无需手动编辑。
                -   从EDAS关联服务场景：服务器列表需要手动设置为http://服务部署到EDAS时对应的ECS实例的IP地址:8080，端口号根据您真实场景设置。
            -   ConnectTimeout：连接服务超时时长，默认值“1000”，可自定义设置。
            -   ReadTimeout：服务读取时长，默认值“3000”，可自定义设置。
            -   MaxTotalHttpConnections：服务最大连接数，默认值“500”，可自定义设置。
            -   MaxConnectionsPerHost：实例最大连接数，默认值“100”，可自定义设置。 |

    -   选择已有策略

        1.  在**API管理**页面**请求处理**区域单击**选择已有策略**。
        2.  在**已有策略**对话框选择策略类型，然后单击**确认**。
        **说明：** 选择已有策略后，默认关闭**启用状态**开关。如需打开，单击策略名称，在**编辑策略**对话框中打开**启用状态**开关。

    您还可以拖动策略名称左侧的![移动](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5693936061/p185670.png)图标以便调整策略的优先级。

7.  在**API管理**页面底部单击**保存并发布**。

    系统弹出**发布详情**对话框，请单击**关闭**。

8.  重启微服务网关。

    1.  在左侧导航栏单击**网关详情**。
    2.  在**网关详情**页面**基本信息**区域单击**重启**，重启微服务网关。

        **说明：** 配置的后端RT自动流量调整的负载均衡策略必须重启微服务网关才会生效。


