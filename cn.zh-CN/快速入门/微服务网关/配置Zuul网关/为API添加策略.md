# 为API添加策略

网关收到访问请求时，通过API的策略判断是否匹配并决定之后的处理动作。策略包含路由策略，负载均衡策略，限流策略和鉴权策略等多种策略。

如果需要为API添加鉴权策略，则需要先创建凭证。具体操作，请参见[新建凭证]()。

添加服务的场景不同，必须为API添加的策略也不同：

-   从注册中心添加服务，必须为API添加路由和负载均衡策略后才能发布生效。
-   从EDAS关联服务，必须为API添加路由策略后才能发布生效。

## 操作步骤

1.  登录[微服务网关控制台](https://microgw.console.aliyun.com)。

2.  在顶部菜单栏选择地域。

3.  在左侧导航栏选择**网关管理**。

4.  在**网关管理**页面单击网关名称。

5.  在**网关详情**页面左侧导航栏单击**API管理**。

6.  在**API管理**页面单击API名称。

7.  在**API详情**页面的**策略**区域确定目标链路，不同链路的策略作用范围不同。

    -   **请求处理**：网关接收到API请求后，最先执行的处理环节。
    -   **响应处理**：网关在生成API请求后，最后执行的处理环节。
    -   **后端请求处理**：网关在发起后端微服务的请求前，最后执行的处理环节。
    -   **后端响应处理**：网关在接收后端微服务的响应后，最先执行的处理环节。
    **说明：** 一般只需配置**请求处理**和**响应处理**两个环节，若涉及需特别强调时机差异处理时可配置后端处理。

8.  在目标链路内添加策略，您可以选择以下任一方式添加策略：

    -   创建新策略
        1.  在目标链路区域单击**创建策略**。
        2.  在**创建策略**对话框选择策略类型，并设置策略信息，然后单击**确认**。

            ![创建新策略](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5677464061/p179923.png)

            |参数|说明|
            |--|--|
            |**策略名称**|仅限字母、数字和下划线（\_），最长255个字符，必须以字母开头。|
            |**策略别名**|易于辨识策略的别名信息。|
            |**策略类型**|根据需要选择策略，本示例选择**路由-ZUUL**。|
            |**启用状态**|策略的启用状态，默认开启。|
            |**策略配置**|根据需要配置策略，也可以在模板基础上配置其它参数。|

    -   选择已有策略
        1.  在目标链路区域单击**选择已有策略**。
        2.  在**已有策略**对话框选中目标策略，单击**确认**。

            ![选择已有策略](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5677464061/p179927.png)

        3.  在目标链路内单击策略名称，在**编辑策略**对话框中开启策略启用开关，然后单击**确认**。

            ![开启策略启用开关](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5677464061/p179932.png)

            **说明：** 选择已有策略，默认不启用该策略，未启用的策略携带![未启用标识](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4003564061/p179979.png)标识。如果需要启用，请开启**启用状态**开关。

9.  同一个链路中如果存在多条策略，鼠标悬停在策略名称上并移动出现的![移动按钮 ](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1898464061/p84983.png)图标，调整策略的优先级。


## 结果验证

API创建成功并添加必要策略后，您可以在控制台直接填写调用参数和发起服务调用请求，并能快速得到服务调用的结果。如果发现请求异常，则根据响应信息排查服务端口、网络或代码的问题。

1.  在API列表中，选择目标API，单击**操作**列下的**测试**。

2.  在测试API面板，选择**调用IP**和**请求方法**并设置**测试参数**，然后单击**执行**。

    **说明：** 如果您是第一次使用或者一个小时内未曾使用测试功能，在使用测试功能前，需要初始化测试引擎。待测试引擎初始化完成后，您才可以使用测试功能。

    ![测试API](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5762514161/p243134.png)

    |参数|描述|
    |--|--|
    |**调用IP**|网关入口SLB的IP。**说明：** 暂不支持HTTPS测试，需选择80端口。 |
    |**请求方法**|调用API的请求方法，包含**POST**、**PUT**、**GET**和**DELETE**。请根据实际情况选择请求方法。 |
    |**测试参数**|根据默认模板填写httpHeaders、params和path等测试参数。本示例仅设置path为实际访问路径/demo/user/rest。 |

3.  在**测试服务**面板的**结果**区域，查看服务调用返回信息。

    -   调用服务成功：显示调用服务的成功响应信息。例如本示例返回的Hello from \[8080\]!。
    -   调用服务失败：显示调用服务的失败响应信息。请根据响应信息，排查服务的端口、网络及代码本身的问题。

