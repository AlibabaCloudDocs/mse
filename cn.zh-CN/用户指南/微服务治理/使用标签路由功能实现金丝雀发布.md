---
keyword: [微服务, 服务治理]
---

# 使用标签路由功能实现金丝雀发布

对于部署在K8s集群中的Spring Cloud或Dubbo微服务应用，为了确保升级操作的安全性，可以使用金丝雀发布（即灰度发布）进行小规模验证，验证通过后再全量升级。

确保在ACK中安装MSE治理中心组件，并为ACK授予MSE治理中心的访问权限，详情请参见[微服务应用接入MSE治理中心]()。

Consumer服务调用Provider服务，这个Provider服务含有两个实例，其中一个Provider实例打上标签，另一个实例未打标签。此时，Consumer只会访问未打标签的Provider实例，打上标签的Provider需配置路由规则，流量满足路由规则后才可被访问。关于标签及部署应用详情请参见[在ACK中为应用接入MSE微服务治理并设置标签]()。

![金丝雀发布示意图](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/9381001061/p169462.png)

## 演示视频



## 为标签应用创建路由规则

1.  登录[MSE管理控制台](https://mse.console.aliyun.com)。

2.  在左侧导航栏选择**微服务治理中心** \> **流量配置** \> **标签路由**。

3.  在**标签路由**页面单击**创建标签路由**。

4.  在**创建标签路由**页面设置参数，然后单击**确定**。

    ![配置路由规则](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/7169480061/p169568.png)

    标签路由参数说明：

    |参数|说明|
    |--|--|
    |**路由名称**|标签路由规则名称，例如`newversion-rule`。|
    |**描述**|规则描述。|
    |**应用**|在列表中选择dev-springcloud-provider应用。|
    |**标签**|在列表中选择在ACK中为应用设置的标签，例如newversion。选择完成后，会在下方**应用实例**区域显示dev-springcloud-provider应用中设置了该标签的应用实例的IP及端口。|
    |**是否链路传递**|如果需要使用全链路流控，请打开**是否链路传递**开关。如需使用，请参见[配置标签路由]()。|
    |**流量规则**|
    |**框架类型**|包含**Spring Cloud**和**Dubbo**，根据应用实际框架自动选择。     -   Spring Cloud：仅支持设置URL的Path，例如`/getIp`。
    -   Dubbo：支持选择服务和接口。 |
    |**条件模式**|包含**同时满足下列条件**和**满足下列任一条件**，根据实际需求选择。|
    |**条件列表**|可以分别设置Parameter、Cookie和Header三种类型的参数。例如：     -   Parameter：`name=newversion`
    -   Cookie：`hello = "world" 或 "world2"` |

    路由规则设置完成后，访问的请求带上规则里的参数，这时流量会去访问打上标签的应用。


金丝雀验证成功 - 全量发布。未打标签的应用版本修改成打了标签的应用版本。

金丝雀验证失败 - 新版本回滚。这个场景下关闭路由规则，规则下次发布的时候可以再次复用。

